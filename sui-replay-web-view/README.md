# Sui Transaction Replay Web Viewer

A comprehensive web-based tool for analyzing Sui transaction replay data with an interactive tabbed interface. This viewer provides detailed analysis of transaction execution, gas usage, and object state changes with a clean, type-safe architecture.

## Purpose & Context

This web viewer is the visual companion to the `sui-replay-2` tool (located in the main Sui repository at `crates/sui-replay-2/`). The replay tool executes Sui transactions in isolation to verify correctness and analyze execution details, then dumps comprehensive JSON artifacts. This web viewer provides an intuitive interface to explore those artifacts.

**Key Use Cases:**
- Debugging transaction execution and gas costs
- Analyzing object lifecycle and state changes
- Understanding package dependencies and module loading
- Verifying gas computation accuracy
- Investigating transaction failures
- Inspecting Move function calls with full type information

**Data Source:** All JSON files are generated by `sui-replay-2` and stored in `.replay/<TRANSACTION_DIGEST>/` directories.

## Features

### üìä **Comprehensive Analysis Tabs**

#### **Overview Tab**
- Transaction details (digest, sender, epoch, checkpoint, protocol version, status with color coding)
- **Programmable Transaction Block (PTB) Analysis:**
  - Full command breakdown with proper Move type display
  - Type arguments shown with hover tooltips for full package addresses
  - Smart type inference for `SplitCoins`, `MergeCoins`, and `MakeMoveVec` commands
  - Consistent type formatting: `module::Type<Args>` (hover shows `0xPackage::module::Type<Args>`)
  - Support for `Option<T>` value parsing (None/Some)
  - Proper indentation and line wrapping for long types and function signatures
- Gas analysis table with proper number alignment
- Gas coins table showing object ID, version, and deletion status

#### **Objects Touched Tab**
- All objects and packages loaded during execution (may not appear in effects)
- Packages with version numbers and module counts
- Input vs dependency package categorization
- Comprehensive view including read-only access and dependencies

#### **Object Changes Tab**
- State changes captured in transaction effects
- Created, deleted, and modified objects with proper categorization
- Objects grouped by usage type (input, gas, runtime)

#### **Gas Analysis Tab**
- Detailed gas constants and cost breakdown
- Per-object gas usage tables with storage costs and rebates
- Created, deleted, and modified object gas analysis
- Gas validation and detailed cost attribution

#### **Raw Json Tab**
- Display of all original JSON artifacts from the replay directory
- Well-formatted, indented JSON for easy reading
- Includes all 5 files: transaction_data.json, transaction_effects.json, transaction_gas_report.json, replay_cache_summary.json, and move_call_info.json
- Each file shown with a description of its contents

### üîó **Explorer Integration**
- Configurable Sui explorer (SuiScan or SuiVision)
- Clickable links for transactions, objects, accounts, and packages
- Visual link styling with hover effects

### üéØ **Type System Features**
- **Consistent Type Display:** All types display as `module::Type` with tooltips showing full package address
- **Proper Type Parsing:** Handles all Move type formats (primitives, structs, vectors, references)
- **Type Inference:** Automatically determines types for commands like `SplitCoins<T>` and `MergeCoins<T>`
- **Function Type Arguments:** Full type information for Move function calls with package-qualified tooltips
- **Option Value Parsing:** Decodes `Option<T>` pure values showing `None` or `Some(value)`

## How to Use

### üìÅ **File Loading Options**

#### **Option 1: Browse Directory (Recommended)**
1. Open `index.html` in your web browser
2. Click "üìÅ Browse Directory" and select the replay directory
3. The app automatically detects these required JSON files:
   - `transaction_data.json`
   - `transaction_effects.json`
   - `transaction_gas_report.json`
   - `replay_cache_summary.json`
   - `move_call_info.json` (optional, for enhanced function signatures)
4. Status indicators show ‚úÖ for found files and ‚ùå for missing files
5. Set your preferred explorer (SuiScan or SuiVision)
6. Click "üîç Analyze Transaction" when ready
7. Navigate through the analysis tabs

#### **Option 2: Drag & Drop Directory**
1. Drag the entire replay directory into the designated drop area
2. Files are automatically scanned and loaded
3. Proceed with analysis

#### **Option 3: Manual Path Entry**
- Type or paste the replay directory path for reference
- Still requires Browse or Drag & Drop for actual file loading (browser security)

## Project Structure

```
sui-replay-web-view/
‚îú‚îÄ‚îÄ index.html                          # Main web application entry point
‚îú‚îÄ‚îÄ styles.css                          # Dark theme styling with responsive design
‚îú‚îÄ‚îÄ transaction-viewer.js               # UI controller and rendering logic
‚îú‚îÄ‚îÄ transaction-model.js                # Domain model: MoveType, MoveFunction, Command classes
‚îú‚îÄ‚îÄ test-transaction-model.html         # Unit tests for transaction model
‚îú‚îÄ‚îÄ TRANSACTION_MODEL_VERIFICATION.md   # Model verification documentation
‚îú‚îÄ‚îÄ CLAUDE.md                          # Development guidelines for AI assistance
‚îî‚îÄ‚îÄ README.md                          # This documentation
```

### Architecture Overview

**Standalone Design:** This is a pure frontend application with no backend dependencies. All processing happens in the browser using vanilla JavaScript.

**Domain-Driven Design:** The codebase uses a clean object-oriented architecture with proper TypeScript-style domain models:

#### **Core Domain Classes (transaction-model.js)**

**`MoveType`** - Represents a Move type with full package information
- Properties: `package`, `module`, `name`, `typeArgs[]`, `isPrimitive`
- Methods:
  - `toDisplayString()` ‚Üí `module::Type<Args>`
  - `toFullyQualifiedString()` ‚Üí `0xPackage::module::Type<Args>`
  - `toHTML()` ‚Üí Formatted HTML with tooltips
  - `static fromTypeStructure(typeObj)` ‚Üí Parses JSON into MoveType

**`MoveFunction`** - Represents a Move function call
- Properties: `package`, `module`, `name`, `typeArgs[]`
- Methods: Same as MoveType for consistent formatting

**`Command`** - Base class for PTB commands
- Subclasses: `MoveCallCommand`, `SplitCoinsCommand`, `MergeCoinsCommand`, `MakeMoveVecCommand`, `TransferObjectsCommand`, `PublishCommand`, `UpgradeCommand`
- Each command knows its own type arguments and can format itself

**`Transaction`** - Main transaction model
- Loads and unifies data from all 5 JSON files
- Provides clean API: `getCommands()`, `getObjectMoveType()`, etc.
- Single source of truth for transaction data

#### **UI Layer (transaction-viewer.js)**
- Uses domain models for all rendering
- No ad-hoc string manipulation for types
- Consistent type display everywhere via `MoveType.toHTML()`

**Key Benefits:**
- **Type Safety:** All types handled uniformly through MoveType class
- **Maintainability:** Single source of truth for type formatting
- **Extensibility:** Easy to add new command types
- **Testability:** Domain models can be unit tested independently

## Quick Start

### **Step 1: Generate Replay Data** (from sui repository)
```bash
# Build the replay tool (from sui repository root)
cd /path/to/sui
cargo build -p sui-replay-2

# Execute a transaction replay
/path/to/sui/target/debug/sui-replay-2 \
  --digest YOUR_TX_DIGEST \
  --overwrite-existing \
  --store-mode inmem-fs-gql

# This creates: path_replay_runs_from/.replay/YOUR_TX_DIGEST/
```

### **Step 2: Launch Web Viewer**

#### **Simple Method (File Protocol)**
```bash
# Navigate to this project
cd $HOME/move-nursery/sui-replay-web-view

# Open directly in browser
open index.html
# or
firefox index.html
```

#### **Local Web Server (Recommended)**
For better performance and to avoid potential CORS issues:

```bash
# Using Python (recommended)
cd $HOME/move-nursery/sui-replay-web-view
python3 -m http.server 8000
# Open http://localhost:8000

# Using Node.js
cd $HOME/move-nursery/sui-replay-web-view
npx serve
# Follow the provided URL
```

### **Step 3: Load Transaction Data**
1. Click "üìÅ Browse Directory" in the web viewer
2. Navigate to `path_replay_runs_from/.replay/YOUR_TX_DIGEST/`
3. Select the directory and click "Analyze Transaction"

## Technical Implementation

### **Type System**

The viewer implements a complete Move type system in JavaScript:

**Primitive Types:**
- Integers: `u8`, `u16`, `u32`, `u64`, `u128`, `u256`
- Other: `bool`, `address`, `signer`
- Built-in generic: `vector<T>` (treated as primitive with type args)

**User-Defined Types:**
- All structs have package address: `0xPackage::module::Struct<TypeArgs>`
- Examples: `coin::Coin<sui::SUI>`, `option::Option<address>`

**Type Format Support:**
- Handles both lowercase `struct` (from command type_arguments)
- Handles capitalized `Struct`/`DatatypeInstantiation` (from object types)
- References: `&T` and `&mut T`

### **Command System**

Each PTB command is represented by a proper class:

```javascript
// Example: SplitCoinsCommand
const splitCmd = SplitCoinsCommand.fromRawCommand(rawCmd, transaction, inputs);
console.log(splitCmd.coinType.toDisplayString()); // "coin::Coin<sui::SUI>"
```

Commands automatically resolve their type arguments from:
- Object types in cache (for object inputs)
- Type parameters from command structure
- Inference for special cases (gas coin = `Coin<SUI>`)

### **Option Value Parsing**

The viewer decodes `Option<T>` pure values using Move's binary encoding:
- First byte `0` = `None`
- First byte `1` = `Some(value)` where value is decoded recursively

Example: `Option<u64>` with bytes `[1, 232, 3, 0, 0, 0, 0, 0, 0]` displays as `Some(1_000)`

### **Core Architecture**
- Pure JavaScript (ES6+) with no external dependencies
- Class-based domain models (TypeScript style)
- Dynamic HTML generation with proper escaping
- Comprehensive error handling and validation

### **Analysis Pipeline**
1. **File Loading**: FileReader API for local file access
2. **Data Parsing**: JSON parsing into domain models (Transaction, MoveType, Command)
3. **Object Analysis**: Transaction effect processing and categorization
4. **Gas Analysis**: Cost calculation and per-object breakdown
5. **UI Generation**: Domain models render themselves to HTML

### **Styling Philosophy**
- Dark terminal-inspired theme for technical data
- Monospace fonts for IDs, addresses, and numerical data
- Color coding for status, types, and interactive elements
- Responsive layout with proper spacing and hierarchy
- Dotted underlines for hover tooltips on types

## Integration with Sui Replay Tool

This web viewer is designed to work seamlessly with the `sui-replay-2` tool from the main Sui repository:

**Sui Repository Location:** `https://github.com/MystenLabs/sui`
**Replay Tool Path:** `crates/sui-replay-2/`
**Output Location:** `path_replay_runs_from/.replay/<TRANSACTION_DIGEST>/`

### Expected JSON Artifacts

The web viewer expects these files in the replay directory:
- `transaction_data.json` - Transaction structure, inputs, and commands
- `transaction_effects.json` - Execution results and state changes
- `transaction_gas_report.json` - Detailed gas usage breakdown
- `replay_cache_summary.json` - Cached objects and packages, epoch, checkpoint, protocol version
- `move_call_info.json` - Move call function signatures with parameter/return types (optional but recommended)

### Development Workflow

```bash
# Terminal 1: Generate replay data (from sui repo)
cd /path/to/sui
./target/debug/sui-replay-2 --digest TX_DIGEST --overwrite-existing --store-mode inmem-fs-gql

# Terminal 2: Run web viewer (from move-nursery)
cd $HOME/move-nursery/sui-replay-web-view
python3 -m http.server 8000

# Browser: Load and analyze
# Navigate to http://localhost:8000 and select .replay/TX_DIGEST/ directory
```

## Recent Improvements

### Type System Refactoring
- **Object-Oriented Architecture:** Complete rewrite using proper domain classes (`MoveType`, `MoveFunction`, `Command`)
- **Consistent Type Display:** All types show as `module::Type` with hover tooltips for full package addresses
- **Type Inference:** Smart detection of coin types for `SplitCoins` and `MergeCoins`
- **Multiple Format Support:** Handles both command and object type JSON formats

### Code Quality
- **+1,100 net lines** for better architecture (from ~4,000 to ~5,100 total)
- **Eliminated duplication:** Centralized type handling in `MoveType` class
- **Better separation:** Domain model vs. UI rendering
- **Easy to extend:** Adding new command types is straightforward

### User Experience
- **Smart wrapping:** Long types and functions wrap intelligently with proper indentation
- **Hover tooltips:** See full package addresses on hover for all types
- **Option parsing:** `Option<T>` values display as `None` or `Some(value)`
- **Consistent styling:** All types formatted identically throughout the app

The web viewer provides comprehensive visual analysis of the replay data with enhanced usability and a clean, maintainable codebase.
